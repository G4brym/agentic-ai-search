<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Search Chat - Government Reports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        .chat-container {
            height: calc(100vh - 200px);
        }
        .message {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator {
            display: inline-block;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9CA3AF;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }
        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0);
            }
            40% { 
                transform: scale(1);
            }
        }
        .source-badge {
            transition: all 0.2s;
        }
        .source-badge:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div class="container mx-auto max-w-4xl p-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üîç AI Search Assistant</h1>
            <p class="text-gray-600">Search through 1,000 government PDF reports from .gov domains</p>
            <div class="mt-3 text-sm text-gray-500">
                <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full mr-2">
                    üìö Government Reports
                </span>
                <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full">
                    ü§ñ AI-Powered
                </span>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="bg-white rounded-lg shadow-md flex flex-col">
            <!-- Messages Area -->
            <div id="chat-messages" class="chat-container overflow-y-auto p-6 space-y-4">
                <!-- Welcome Message -->
                <div class="message">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold">
                            AI
                        </div>
                        <div class="flex-1">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border border-blue-100">
                                <p class="text-gray-800">
                                    üëã Hello! I'm your AI search assistant. I can help you search through a collection of 1,000 government PDF reports from .gov domains.
                                </p>
                                <p class="text-gray-800 mt-2">
                                    Ask me anything about the reports, and I'll search through them to find relevant information!
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 p-4">
                <form id="chat-form" class="flex space-x-3">
                    <input 
                        type="text" 
                        id="user-input" 
                        placeholder="Ask about government reports..." 
                        class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        autocomplete="off"
                    >
                    <button 
                        type="submit" 
                        id="send-btn"
                        class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Send
                    </button>
                </form>
                <div class="mt-2 text-xs text-gray-500 text-center">
                    Powered by Cloudflare Workers AI & AutoRAG
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            const $chatMessages = $('#chat-messages');
            const $userInput = $('#user-input');
            const $chatForm = $('#chat-form');
            const $sendBtn = $('#send-btn');
            
            // WebSocket connection
            let ws = null;
            let currentMessageId = null;
            let currentMessageText = '';
            
            // Connect to the agent via WebSocket
            function connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/agents/search-agent/default`;
                
                console.log('Connecting to:', wsUrl);
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('Received:', data);
                        
                        // Handle different message types from the AI SDK data stream
                        if (data.type === 'search-start') {
                            // Show search query to user
                            addSearchNotification(data.query);
                        } else if (data.type === 'text-delta' || data[0] === 0) {
                            // Text delta - streaming text chunks
                            const text = data.type === 'text-delta' ? data.textDelta : data[1];
                            if (text) {
                                if (!currentMessageId) {
                                    currentMessageId = addStreamingMessage();
                                    currentMessageText = '';
                                }
                                currentMessageText += text;
                                updateStreamingMessage(currentMessageId, currentMessageText);
                            }
                        } else if (data.type === 'tool-call') {
                            console.log('Tool called:', data.toolName, data.args);
                        } else if (data.type === 'tool-result') {
                            console.log('Tool result:', data.toolName, data.result);
                            // Optionally show tool results
                            if (data.result && data.result.found && data.result.results) {
                                console.log(`Found ${data.result.count} results`);
                            }
                        } else if (data.type === 'finish' || data[0] === 'd') {
                            // Stream finished
                            currentMessageId = null;
                            currentMessageText = '';
                            removeTypingIndicator();
                        } else if (data.type === 'error') {
                            removeTypingIndicator();
                            addErrorMessage(data.error || 'An error occurred');
                            currentMessageId = null;
                            currentMessageText = '';
                        }
                    } catch (e) {
                        console.error('Error parsing message:', e, event.data);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    addErrorMessage('Connection error. Please refresh the page.');
                };
                
                ws.onclose = () => {
                    console.log('WebSocket closed');
                    // Try to reconnect after 3 seconds
                    setTimeout(connectWebSocket, 3000);
                };
            }
            
            // Connect on page load
            connectWebSocket();

            // Auto-scroll to bottom
            function scrollToBottom() {
                $chatMessages.scrollTop($chatMessages[0].scrollHeight);
            }

            // Add user message
            function addUserMessage(text) {
                const messageHtml = `
                    <div class="message">
                        <div class="flex items-start space-x-3 justify-end">
                            <div class="flex-1 flex justify-end">
                                <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg p-4 max-w-xl shadow-md">
                                    <p>${escapeHtml(text)}</p>
                                </div>
                            </div>
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-gray-400 to-gray-500 flex items-center justify-center text-white font-bold">
                                U
                            </div>
                        </div>
                    </div>
                `;
                $chatMessages.append(messageHtml);
                scrollToBottom();
            }

            // Add typing indicator
            function addTypingIndicator() {
                const typingHtml = `
                    <div class="message typing-message">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold">
                                AI
                            </div>
                            <div class="flex-1">
                                <div class="bg-gray-100 rounded-lg p-4 inline-block">
                                    <div class="typing-indicator">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                $chatMessages.append(typingHtml);
                scrollToBottom();
            }

            // Remove typing indicator
            function removeTypingIndicator() {
                $('.typing-message').remove();
            }

            // Add AI message with sources
            function addAIMessage(text, sources = []) {
                removeTypingIndicator();
                
                let sourcesHtml = '';
                if (sources && sources.length > 0) {
                    sourcesHtml = '<div class="mt-3 pt-3 border-t border-blue-200"><p class="text-xs font-semibold text-gray-600 mb-2">üìé Sources:</p><div class="space-y-1">';
                    sources.forEach((source, index) => {
                        sourcesHtml += `
                            <div class="source-badge text-xs bg-white border border-blue-200 rounded px-2 py-1 cursor-pointer hover:bg-blue-50">
                                <span class="font-medium text-blue-600">${index + 1}.</span>
                                <span class="text-gray-700">${escapeHtml(source.filename || 'Unknown')}</span>
                                ${source.score ? `<span class="text-gray-500 ml-1">(${(source.score * 100).toFixed(0)}%)</span>` : ''}
                            </div>
                        `;
                    });
                    sourcesHtml += '</div></div>';
                }

                const messageHtml = `
                    <div class="message">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold">
                                AI
                            </div>
                            <div class="flex-1">
                                <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border border-blue-100">
                                    <div class="text-gray-800 whitespace-pre-wrap">${escapeHtml(text)}</div>
                                    ${sourcesHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                $chatMessages.append(messageHtml);
                scrollToBottom();
            }

            // Add error message
            function addErrorMessage(text) {
                removeTypingIndicator();
                const messageHtml = `
                    <div class="message">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-red-500 flex items-center justify-center text-white font-bold">
                                ‚ö†Ô∏è
                            </div>
                            <div class="flex-1">
                                <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                                    <p class="text-red-800">${escapeHtml(text)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                $chatMessages.append(messageHtml);
                scrollToBottom();
            }

            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Add streaming AI message
            function addStreamingMessage() {
                removeTypingIndicator();
                const messageId = 'msg-' + Date.now();
                const messageHtml = `
                    <div class="message" id="${messageId}">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold">
                                AI
                            </div>
                            <div class="flex-1">
                                <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border border-blue-100">
                                    <div class="text-gray-800 whitespace-pre-wrap streaming-text"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                $chatMessages.append(messageHtml);
                scrollToBottom();
                return messageId;
            }

            // Update streaming message
            function updateStreamingMessage(messageId, text) {
                $(`#${messageId} .streaming-text`).text(text);
                scrollToBottom();
            }

            // Add search notification
            function addSearchNotification(query) {
                const notificationHtml = `
                    <div class="message search-notification">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-teal-500 flex items-center justify-center text-white font-bold">
                                üîç
                            </div>
                            <div class="flex-1">
                                <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-lg p-3 border border-green-200">
                                    <p class="text-sm text-gray-700">
                                        <span class="font-semibold text-green-700">Searching:</span> ${escapeHtml(query)}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                $chatMessages.append(notificationHtml);
                scrollToBottom();
            }

            // Handle form submission via WebSocket
            $chatForm.on('submit', function(e) {
                e.preventDefault();
                
                const userMessage = $userInput.val().trim();
                if (!userMessage) return;
                
                // Check if WebSocket is connected
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    addErrorMessage('Not connected. Please wait a moment and try again.');
                    return;
                }

                // Disable input
                $userInput.prop('disabled', true);
                $sendBtn.prop('disabled', true);

                // Add user message
                addUserMessage(userMessage);
                $userInput.val('');

                // Add typing indicator
                addTypingIndicator();

                try {
                    // Send message via WebSocket
                    ws.send(JSON.stringify({
                        messages: [
                            { role: 'user', content: userMessage }
                        ]
                    }));
                } catch (error) {
                    console.error('Error sending message:', error);
                    addErrorMessage('Failed to send message. Please try again.');
                    removeTypingIndicator();
                } finally {
                    // Re-enable input after a short delay
                    setTimeout(() => {
                        $userInput.prop('disabled', false);
                        $sendBtn.prop('disabled', false);
                        $userInput.focus();
                    }, 500);
                }
            });

            // Focus input on load
            $userInput.focus();
        });
    </script>
</body>
</html>
